const axios = require('axios');
const cheerio = require('cheerio');

class CompleteNewsSystemWithEnhancements {
    constructor() {
        this.cache = new Map();
        this.cacheExpiry = 10 * 60 * 1000; // 10ë¶„
        this.lastUpdate = null;
        this.isUpdating = false;
        
        // API ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
        this.apiMetrics = {
            newsApi: { success: 0, failure: 0, totalTime: 0, lastError: null },
            naverApi: { success: 0, failure: 0, totalTime: 0, lastError: null },
            openAi: { success: 0, failure: 0, totalTime: 0, lastError: null },
            skyworkAi: { success: 0, failure: 0, totalTime: 0, lastError: null },
            exchangeApi: { success: 0, failure: 0, totalTime: 0, lastError: null }
        };
        
        // API ì„¤ì •
        this.apis = {
            newsApi: process.env.NEWS_API_KEY || '44d9347a149b40ad87b3deb8bba95183',
            openAi: process.env.OPENAI_API_KEY,
            skyworkAi: process.env.SKYWORK_API_KEY,
            naverClientId: process.env.NAVER_CLIENT_ID || '4lsPsi_je8UoGGcfTP1w',
            naverClientSecret: process.env.NAVER_CLIENT_SECRET || 'J3BHRgyWPc',
            exchangeApiKey: process.env.EXCHANGE_API_KEY || 'free' // ë¬´ë£Œ í™˜ìœ¨ API ì‚¬ìš©
        };

        // Rate Limiting ì„¤ì • (ëŒ€í­ ì¦ê°€)
        this.rateLimits = {
            naver: { requests: 0, resetTime: Date.now() + 60000, maxRequests: 50000 }, // ì¼ì¼ 50,000íšŒ
            newsApi: { requests: 0, resetTime: Date.now() + 3600000, maxRequests: 2000 }, // ì‹œê°„ë‹¹ 2,000íšŒ
            openAi: { requests: 0, resetTime: Date.now() + 60000, maxRequests: 100 }, // ë¶„ë‹¹ 100íšŒ
            skywork: { requests: 0, resetTime: Date.now() + 60000, maxRequests: 200 }, // ë¶„ë‹¹ 200íšŒ
            exchange: { requests: 0, resetTime: Date.now() + 3600000, maxRequests: 1000 } // ì‹œê°„ë‹¹ 1,000íšŒ
        };

        // ë‰´ìŠ¤ ì†ŒìŠ¤ ë§¤í•‘ (ëŒ€í­ í™•ì¥)
        this.sourceMapping = {
            // ê¸€ë¡œë²Œ ì†ŒìŠ¤
            'bbc-news': 'BBC News',
            'cnn': 'CNN',
            'reuters': 'Reuters',
            'associated-press': 'AP í†µì‹ ',
            'the-guardian-uk': 'The Guardian',
            'the-new-york-times': 'New York Times',
            'the-washington-post': 'Washington Post',
            'bloomberg': 'Bloomberg',
            'financial-times': 'Financial Times',
            'wall-street-journal': 'Wall Street Journal',
            'usa-today': 'USA Today',
            'abc-news': 'ABC News',
            'fox-news': 'Fox News',
            'nbc-news': 'NBC News',
            'cbs-news': 'CBS News',
            'time': 'Time Magazine',
            'newsweek': 'Newsweek',
            'the-economist': 'The Economist',
            
            // í•œêµ­ ì†ŒìŠ¤
            'yonhap-news-agency': 'ì—°í•©ë‰´ìŠ¤',
            'chosun': 'ì¡°ì„ ì¼ë³´',
            'joongang': 'ì¤‘ì•™ì¼ë³´',
            'donga': 'ë™ì•„ì¼ë³´',
            'hankyoreh': 'í•œê²¨ë ˆ',
            'khan': 'ê²½í–¥ì‹ ë¬¸',
            'hani': 'í•œê²¨ë ˆì‹ ë¬¸',
            'seoul-shinmun': 'ì„œìš¸ì‹ ë¬¸',
            'kookmin-ilbo': 'êµ­ë¯¼ì¼ë³´',
            'munhwa': 'ë¬¸í™”ì¼ë³´',
            'segye': 'ì„¸ê³„ì¼ë³´',
            
            // ì¼ë³¸ ì†ŒìŠ¤
            'nhk-world': 'NHK World',
            'japan-times': 'Japan Times',
            'asahi-shimbun': 'ì•„ì‚¬íˆì‹ ë¬¸',
            'mainichi-shimbun': 'ë§ˆì´ë‹ˆì¹˜ì‹ ë¬¸',
            'yomiuri-shimbun': 'ìš”ë¯¸ìš°ë¦¬ì‹ ë¬¸',
            'nikkei': 'ë‹ˆí˜¼ê²Œì´ìì´ì‹ ë¬¸',
            'kyodo-news': 'êµë„í†µì‹ ',
            'jiji-press': 'ì§€ì§€í†µì‹ '
        };

        // í‚¤ì›Œë“œ ë¶„ë¥˜ (ëŒ€í­ í™•ì¥)
        this.keywords = {
            urgent: ['ê¸´ê¸‰', 'ì†ë³´', 'ë°œìƒ', 'ì‚¬ê³ ', 'ì¬í•´', 'ìœ„ê¸°', 'ê²½ë³´', 'ë¹„ìƒ', 'ëŒë°œ', 'ì‘ê¸‰', 'breaking', 'urgent', 'alert', 'emergency', 'crisis', 'disaster'],
            important: ['ì¤‘ìš”', 'ë°œí‘œ', 'ê²°ì •', 'ìŠ¹ì¸', 'í•©ì˜', 'ì²´ê²°', 'ë°œíš¨', 'ì‹œí–‰', 'ì„ ì–¸', 'ê³µì‹', 'important', 'significant', 'major', 'key', 'crucial', 'critical'],
            buzz: ['í™”ì œ', 'ì¸ê¸°', 'íŠ¸ë Œë“œ', 'ë°”ì´ëŸ´', 'ë…¼ë€', 'ê´€ì‹¬', 'ì£¼ëª©', 'ì´ìŠˆ', 'ì„¼ì„¸ì´ì…˜', 'viral', 'trending', 'popular', 'buzz', 'sensation', 'hot'],
            
            // ì§€ì—­ë³„ í‚¤ì›Œë“œ (í™•ì¥)
            korea: ['í•œêµ­', 'ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼', 'korea', 'seoul', 'korean', 'ì†í¥ë¯¼', 'ì´ê°•ì¸', 'bts', 'ë¸”ë™í•‘í¬'],
            japan: ['ì¼ë³¸', 'ë„ì¿„', 'ì˜¤ì‚¬ì¹´', 'êµí† ', 'ìš”ì½”í•˜ë§ˆ', 'ë‚˜ê³ ì•¼', 'ê³ ë² ', 'í›„ì¿ ì˜¤ì¹´', 'ì‚¿í¬ë¡œ', 'ì„¼ë‹¤ì´', 'ì˜¤íƒ€ë‹ˆ', 'ì‡¼í—¤ì´', 'ë‹¤ë¥´ë¹„ì‹œ', 'japan', 'tokyo', 'japanese', 'ohtani', 'shohei', 'darvish', 'suzuki', 'maeda'],
            
            // ìŠ¤í¬ì¸  ì¸ë¬¼ (ì¼ë³¸ ë¶„ë¥˜ìš©)
            japanSports: ['ì˜¤íƒ€ë‹ˆ', 'ì‡¼í—¤ì´', 'ë‹¤ë¥´ë¹„ì‹œ', 'ë§ˆì—ë‹¤', 'ìŠ¤ì¦ˆí‚¤', 'ë‹¤ë‚˜ì¹´', 'êµ¬ë¡œë‹¤', 'ohtani', 'shohei', 'darvish', 'maeda', 'suzuki', 'tanaka', 'kuroda', 'baseball', 'mlb', 'npb']
        };

        // í™˜ìœ¨ ìºì‹œ
        this.exchangeRates = {
            USD_KRW: 1340,
            JPY_KRW: 9.2,
            lastUpdate: null
        };

        console.log('ğŸš€ ì™„ì „ ê°œì„ ëœ ë‰´ìŠ¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ - ëŒ€ëŸ‰ ìˆ˜ì§‘ ëª¨ë“œ í™œì„±í™”');
    }

    // Exponential Backoff ì¬ì‹œë„ ë¡œì§ (ê°œì„ )
    async retryWithBackoff(apiCall, apiName, maxRetries = 5) {
        const startTime = Date.now();
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`ğŸ“¡ ${apiName} API í˜¸ì¶œ ì‹œë„ ${attempt}/${maxRetries}`);
                
                const result = await apiCall();
                
                // ì„±ê³µ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
                const duration = Date.now() - startTime;
                this.updateApiMetrics(apiName, true, duration);
                
                console.log(`âœ… ${apiName} API í˜¸ì¶œ ì„±ê³µ (${duration}ms)`);
                return result;
                
            } catch (error) {
                const duration = Date.now() - startTime;
                console.error(`âŒ ${apiName} API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempt}/${maxRetries}):`, error.message);
                
                // ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¬ì‹œë„
                if (attempt < maxRetries) {
                    const delay = Math.min(1000 * Math.pow(2, attempt - 1), 15000); // ìµœëŒ€ 15ì´ˆ
                    console.log(`â³ ${delay}ms í›„ ì¬ì‹œë„...`);
                    await this.sleep(delay);
                } else {
                    // ì‹¤íŒ¨ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
                    this.updateApiMetrics(apiName, false, duration, error.message);
                    throw error;
                }
            }
        }
    }

    // API ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
    updateApiMetrics(apiName, success, duration, errorMessage = null) {
        const metric = this.apiMetrics[apiName];
        if (!metric) return;

        if (success) {
            metric.success++;
        } else {
            metric.failure++;
            metric.lastError = errorMessage;
        }
        
        metric.totalTime += duration;
        
        console.log(`ğŸ“Š ${apiName} ë©”íŠ¸ë¦­: ì„±ê³µ ${metric.success}, ì‹¤íŒ¨ ${metric.failure}, í‰ê·  ì‘ë‹µì‹œê°„ ${Math.round(metric.totalTime / (metric.success + metric.failure))}ms`);
    }

    // Rate Limit í™•ì¸
    checkRateLimit(apiName) {
        const limit = this.rateLimits[apiName];
        if (!limit) return true;

        const now = Date.now();
        if (now > limit.resetTime) {
            limit.requests = 0;
            const resetInterval = apiName === 'naver' ? 86400000 : apiName === 'newsApi' ? 3600000 : 60000;
            limit.resetTime = now + resetInterval;
        }

        if (limit.requests >= limit.maxRequests) {
            console.warn(`âš ï¸ ${apiName} API Rate Limit ë„ë‹¬: ${limit.requests}/${limit.maxRequests}`);
            return false;
        }

        limit.requests++;
        return true;
    }

    // ê°•ì œ ìºì‹œ ë¬´íš¨í™” ì§€ì›
    async getNews(forceRefresh = false, timestamp = null) {
        const cacheKey = 'news_data';
        
        if (forceRefresh || timestamp || !this.cache.has(cacheKey) || this.isCacheExpired(cacheKey)) {
            console.log('ğŸ”„ ëŒ€ëŸ‰ ë‰´ìŠ¤ ë°ì´í„° ìƒˆë¡œ ìˆ˜ì§‘ ì¤‘...', forceRefresh ? '(ê°•ì œ ìƒˆë¡œê³ ì¹¨)' : '');
            
            if (this.isUpdating && !forceRefresh) {
                console.log('âš ï¸ ì´ë¯¸ ì—…ë°ì´íŠ¸ ì¤‘ì…ë‹ˆë‹¤.');
                return this.cache.get(cacheKey)?.data || this.getDefaultNews();
            }

            this.isUpdating = true;
            
            try {
                const newsData = await this.collectAllNews();
                
                this.cache.set(cacheKey, {
                    data: newsData,
                    timestamp: Date.now()
                });
                
                this.lastUpdate = new Date().toISOString();
                console.log('âœ… ëŒ€ëŸ‰ ë‰´ìŠ¤ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ');
                
                return newsData;
            } catch (error) {
                console.error('âŒ ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹¤íŒ¨:', error);
                return this.cache.get(cacheKey)?.data || this.getDefaultNews();
            } finally {
                this.isUpdating = false;
            }
        }

        return this.cache.get(cacheKey).data;
    }

    // ìºì‹œ ë§Œë£Œ í™•ì¸
    isCacheExpired(key) {
        const cached = this.cache.get(key);
        if (!cached) return true;
        return Date.now() - cached.timestamp > this.cacheExpiry;
    }

    // ëª¨ë“  ë‰´ìŠ¤ ìˆ˜ì§‘ (ëŒ€ëŸ‰ ìˆ˜ì§‘ ëª¨ë“œ)
    async collectAllNews() {
        console.log('ğŸ“¡ ëŒ€ëŸ‰ ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘ - ê° ì„¹ì…˜ 20-30ê°œ ëª©í‘œ');
        
        // ì‹¤ì‹œê°„ í™˜ìœ¨ ì—…ë°ì´íŠ¸
        await this.updateExchangeRates();
        
        // ë³‘ë ¬ ì²˜ë¦¬í•˜ë˜ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
        const results = await Promise.allSettled([
            this.fetchWorldNewsLarge(),
            this.fetchKoreaNewsLarge(),
            this.fetchJapanNewsLarge()
        ]);

        const worldNews = results[0].status === 'fulfilled' ? results[0].value : [];
        const koreaNews = results[1].status === 'fulfilled' ? results[1].value : [];
        const japanNews = results[2].status === 'fulfilled' ? results[2].value : [];

        // ì‹¤íŒ¨í•œ ì„¹ì…˜ ë¡œê¹…
        results.forEach((result, index) => {
            const sections = ['ì„¸ê³„ë‰´ìŠ¤', 'í•œêµ­ë‰´ìŠ¤', 'ì¼ë³¸ë‰´ìŠ¤'];
            if (result.status === 'rejected') {
                console.error(`âŒ ${sections[index]} ëŒ€ëŸ‰ ìˆ˜ì§‘ ì‹¤íŒ¨:`, result.reason.message);
            }
        });
        
        // íŠ¸ë Œë”© í‚¤ì›Œë“œ ìƒì„±
        const trending = await this.generateTrendingKeywords([...worldNews, ...koreaNews, ...japanNews]);

        const result = {
            sections: {
                world: worldNews.slice(0, 30), // ìµœëŒ€ 30ê°œ
                korea: koreaNews.slice(0, 30),
                japan: japanNews.slice(0, 30)
            },
            trending,
            exchangeRates: this.exchangeRates,
            systemStatus: {
                version: '10.0.0-complete-enhanced',
                lastUpdate: this.lastUpdate,
                cacheSize: this.cache.size,
                features: ['large-scale-collection', 'real-time-exchange', 'enhanced-translation', 'source-verification', 'detailed-content'],
                apiMetrics: this.getApiMetricsReport(),
                apiSources: {
                    newsApi: !!this.apis.newsApi,
                    naverApi: !!(this.apis.naverClientId && this.apis.naverClientSecret),
                    openAi: !!this.apis.openAi,
                    skyworkAi: !!this.apis.skyworkAi,
                    exchangeApi: true
                }
            }
        };

        console.log('ğŸ“Š ëŒ€ëŸ‰ ìˆ˜ì§‘ ì™„ë£Œ:', {
            world: result.sections.world.length,
            korea: result.sections.korea.length,
            japan: result.sections.japan.length,
            trending: result.trending.length,
            exchangeRates: this.exchangeRates
        });

        return result;
    }

    // ì‹¤ì‹œê°„ í™˜ìœ¨ ì—…ë°ì´íŠ¸
    async updateExchangeRates() {
        try {
            if (!this.checkRateLimit('exchange')) {
                console.warn('âš ï¸ í™˜ìœ¨ API Rate Limit ë„ë‹¬');
                return;
            }

            console.log('ğŸ’± ì‹¤ì‹œê°„ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì¤‘...');
            
            // ë¬´ë£Œ í™˜ìœ¨ API ì‚¬ìš© (exchangerate-api.com)
            const response = await this.retryWithBackoff(
                () => axios.get('https://api.exchangerate-api.com/v4/latest/USD', {
                    timeout: 10000
                }),
                'exchangeApi'
            );

            if (response.data && response.data.rates) {
                const krwRate = response.data.rates.KRW;
                const jpyRate = response.data.rates.JPY;
                
                this.exchangeRates = {
                    USD_KRW: Math.round(krwRate),
                    JPY_KRW: Math.round((krwRate / jpyRate) * 10) / 10,
                    lastUpdate: new Date().toISOString()
                };
                
                console.log('âœ… í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', this.exchangeRates);
            }
        } catch (error) {
            console.error('âŒ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error.message);
            // ê¸°ë³¸ê°’ ìœ ì§€
        }
    }

    // ì„¸ê³„ ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ (20-30ê°œ)
    async fetchWorldNewsLarge() {
        const sources = [
            { endpoint: 'top-headlines', params: { category: 'general', language: 'en', pageSize: 50 } },
            { endpoint: 'everything', params: { q: 'world OR global OR international', language: 'en', pageSize: 40, sortBy: 'publishedAt' } },
            { endpoint: 'top-headlines', params: { category: 'business', language: 'en', pageSize: 30 } },
            { endpoint: 'top-headlines', params: { category: 'technology', language: 'en', pageSize: 30 } },
            { endpoint: 'top-headlines', params: { category: 'science', language: 'en', pageSize: 20 } },
            { endpoint: 'everything', params: { q: 'politics OR government', language: 'en', pageSize: 25, sortBy: 'publishedAt' } },
            { endpoint: 'everything', params: { q: 'economy OR finance', language: 'en', pageSize: 25, sortBy: 'publishedAt' } }
        ];

        let allArticles = [];
        
        for (const source of sources) {
            try {
                if (!this.checkRateLimit('newsApi')) {
                    console.warn('âš ï¸ NewsAPI Rate Limit ë„ë‹¬, ê±´ë„ˆë›°ê¸°');
                    continue;
                }

                const articles = await this.retryWithBackoff(
                    () => this.fetchFromNewsAPI(source.endpoint, source.params),
                    'newsApi'
                );
                allArticles = allArticles.concat(articles);
                
                // API í˜¸ì¶œ ê°„ê²©
                await this.sleep(200);
            } catch (error) {
                console.error(`âŒ ì„¸ê³„ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ ì‹¤íŒ¨ (${source.endpoint}):`, error.message);
            }
        }

        const uniqueArticles = this.removeDuplicates(allArticles);
        const recentArticles = this.filterRecentNews(uniqueArticles);
        const processedArticles = await this.processArticlesForMobileEnhanced(recentArticles, 'world');

        console.log(`ğŸ“ˆ ì„¸ê³„ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ ê²°ê³¼: ${processedArticles.length}ê°œ`);
        return processedArticles.slice(0, 25);
    }

    // í•œêµ­ ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ (20-30ê°œ)
    async fetchKoreaNewsLarge() {
        let allArticles = [];

        // Naver APIì—ì„œ ëŒ€ëŸ‰ ìˆ˜ì§‘
        try {
            if (this.checkRateLimit('naver')) {
                const naverArticles = await this.retryWithBackoff(
                    () => this.fetchFromNaverAPILarge(),
                    'naverApi'
                );
                allArticles = allArticles.concat(naverArticles);
            } else {
                console.warn('âš ï¸ Naver API Rate Limit ë„ë‹¬, ê±´ë„ˆë›°ê¸°');
            }
        } catch (error) {
            console.error('âŒ Naver API ëŒ€ëŸ‰ ìˆ˜ì§‘ ì‹¤íŒ¨:', error.message);
        }

        // NewsAPIì—ì„œ í•œêµ­ ê´€ë ¨ ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘
        const newsApiSources = [
            { endpoint: 'everything', params: { q: 'Korea OR Korean OR Seoul', language: 'en', pageSize: 30, sortBy: 'publishedAt' } },
            { endpoint: 'everything', params: { q: 'South Korea OR K-pop OR Samsung', language: 'en', pageSize: 20, sortBy: 'publishedAt' } },
            { endpoint: 'everything', params: { q: 'í•œêµ­ OR ì„œìš¸ OR ì‚¼ì„±', pageSize: 15, sortBy: 'publishedAt' } }
        ];

        for (const source of newsApiSources) {
            try {
                if (!this.checkRateLimit('newsApi')) continue;

                const articles = await this.retryWithBackoff(
                    () => this.fetchFromNewsAPI(source.endpoint, source.params),
                    'newsApi'
                );
                
                const koreanArticles = articles.filter(article => 
                    this.containsKeywords(article.title + ' ' + article.description, this.keywords.korea)
                );
                allArticles = allArticles.concat(koreanArticles);
                
                await this.sleep(200);
            } catch (error) {
                console.error(`âŒ í•œêµ­ë‰´ìŠ¤ NewsAPI ëŒ€ëŸ‰ ìˆ˜ì§‘ ì‹¤íŒ¨:`, error.message);
            }
        }

        const uniqueArticles = this.removeDuplicates(allArticles);
        const recentArticles = this.filterRecentNews(uniqueArticles);
        const processedArticles = await this.processArticlesForMobileEnhanced(recentArticles, 'korea');

        console.log(`ğŸ“ˆ í•œêµ­ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ ê²°ê³¼: ${processedArticles.length}ê°œ`);
        return processedArticles.slice(0, 25);
    }

    // ì¼ë³¸ ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ (20-30ê°œ)
    async fetchJapanNewsLarge() {
        const sources = [
            { 
                endpoint: 'everything', 
                params: { 
                    q: 'Japan OR Japanese OR Tokyo OR Ohtani OR Shohei', 
                    language: 'en', 
                    pageSize: 40, 
                    sortBy: 'publishedAt',
                    from: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                } 
            },
            { 
                endpoint: 'top-headlines', 
                params: { 
                    country: 'jp', 
                    pageSize: 30 
                } 
            },
            { 
                endpoint: 'everything', 
                params: { 
                    q: 'MLB AND (Ohtani OR Shohei OR Darvish)', 
                    language: 'en', 
                    pageSize: 25, 
                    sortBy: 'publishedAt',
                    from: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                } 
            },
            { 
                endpoint: 'everything', 
                params: { 
                    q: 'Nintendo OR Sony OR Toyota OR Honda', 
                    language: 'en', 
                    pageSize: 20, 
                    sortBy: 'publishedAt'
                } 
            },
            { 
                endpoint: 'everything', 
                params: { 
                    q: 'ì¼ë³¸ OR ë„ì¿„ OR ì˜¤íƒ€ë‹ˆ OR ì‡¼í—¤ì´', 
                    pageSize: 15, 
                    sortBy: 'publishedAt'
                } 
            }
        ];

        let allArticles = [];
        
        for (const source of sources) {
            try {
                if (!this.checkRateLimit('newsApi')) continue;

                console.log(`ğŸ“ ì¼ë³¸ë‰´ìŠ¤ ëŒ€ëŸ‰ API ìš”ì²­:`, {
                    endpoint: source.endpoint,
                    params: source.params
                });

                const articles = await this.retryWithBackoff(
                    () => this.fetchFromNewsAPI(source.endpoint, source.params),
                    'newsApi'
                );
                
                // ì¼ë³¸ ê´€ë ¨ í‚¤ì›Œë“œë¡œ í•„í„°ë§
                const japanArticles = articles.filter(article => {
                    const content = (article.title + ' ' + article.description).toLowerCase();
                    return this.containsKeywords(content, this.keywords.japan) || 
                           this.containsKeywords(content, this.keywords.japanSports);
                });
                
                console.log(`ğŸ“Š ${source.endpoint}ì—ì„œ ${japanArticles.length}ê°œ ì¼ë³¸ ê´€ë ¨ ê¸°ì‚¬ í•„í„°ë§`);
                allArticles = allArticles.concat(japanArticles);
                
                await this.sleep(200);
            } catch (error) {
                console.error(`âŒ ì¼ë³¸ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ ì‹¤íŒ¨ (${source.endpoint}):`, error.message);
                
                if (error.response?.status === 400) {
                    console.error('ğŸ“‹ 400 ì˜¤ë¥˜ ìƒì„¸:', {
                        status: error.response.status,
                        data: error.response.data,
                        params: source.params
                    });
                }
            }
        }

        const uniqueArticles = this.removeDuplicates(allArticles);
        const recentArticles = this.filterRecentNews(uniqueArticles);
        const processedArticles = await this.processArticlesForMobileEnhanced(recentArticles, 'japan');

        console.log(`ğŸ“ˆ ì¼ë³¸ë‰´ìŠ¤ ëŒ€ëŸ‰ ìˆ˜ì§‘ ê²°ê³¼: ${processedArticles.length}ê°œ`);
        return processedArticles.slice(0, 25);
    }

    // Naver API ëŒ€ëŸ‰ ìˆ˜ì§‘
    async fetchFromNaverAPILarge() {
        const queries = ['ë‰´ìŠ¤', 'ì •ì¹˜', 'ê²½ì œ', 'ì‚¬íšŒ', 'êµ­ì œ', 'ìŠ¤í¬ì¸ ', 'ì—°ì˜ˆ', 'ê³¼í•™', 'ê¸°ìˆ ', 'IT']; // ì¿¼ë¦¬ í™•ì¥
        let allArticles = [];

        for (const query of queries) {
            try {
                if (!this.checkRateLimit('naver')) {
                    console.warn('âš ï¸ Naver API Rate Limit ë„ë‹¬, ì¤‘ë‹¨');
                    break;
                }

                const config = {
                    params: {
                        query,
                        display: 20, // ê° ì¿¼ë¦¬ë‹¹ 20ê°œ
                        start: 1,
                        sort: 'date'
                    },
                    headers: {
                        'X-Naver-Client-Id': this.apis.naverClientId,
                        'X-Naver-Client-Secret': this.apis.naverClientSecret,
                        'User-Agent': 'EmarkNews/10.0.0'
                    },
                    timeout: 12000
                };

                console.log(`ğŸ“¡ Naver API ëŒ€ëŸ‰ ìš”ì²­: ${query}`);

                const response = await axios.get('https://openapi.naver.com/v1/search/news.json', config);
                
                const articles = (response.data.items || []).map(item => ({
                    id: this.generateId(item.link),
                    title: this.cleanNaverText(item.title),
                    description: this.cleanNaverText(item.description),
                    url: item.link,
                    originalUrl: item.originallink || item.link,
                    image: null,
                    publishedAt: item.pubDate,
                    source: {
                        name: 'Naver News',
                        display: this.getSourceDisplay('Naver News', item.pubDate)
                    }
                }));

                console.log(`âœ… Naver API ${query}ì—ì„œ ${articles.length}ê°œ ê¸°ì‚¬ ìˆ˜ì§‘`);
                allArticles = allArticles.concat(articles);
                
                // API í˜¸ì¶œ ê°„ê²© (Rate Limit ë°©ì§€)
                await this.sleep(150);
                
            } catch (error) {
                console.error(`âŒ Naver API ì¿¼ë¦¬ ì‹¤íŒ¨ (${query}):`, error.message);
                
                if (error.response?.status === 429) {
                    console.error('ğŸ“‹ 429 ì˜¤ë¥˜ ìƒì„¸:', {
                        status: error.response.status,
                        headers: error.response.headers,
                        data: error.response.data
                    });
                    
                    this.rateLimits.naver.requests = this.rateLimits.naver.maxRequests;
                    break;
                }
            }
        }

        return allArticles;
    }

    // NewsAPI í˜¸ì¶œ (ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬)
    async fetchFromNewsAPI(endpoint, params) {
        const baseUrl = 'https://newsapi.org/v2';
        const url = `${baseUrl}/${endpoint}`;
        
        // íŒŒë¼ë¯¸í„° ê²€ì¦
        const validatedParams = this.validateNewsAPIParams(params);
        
        const config = {
            params: {
                ...validatedParams,
                apiKey: this.apis.newsApi
            },
            timeout: 20000, // íƒ€ì„ì•„ì›ƒ ì¦ê°€
            headers: {
                'User-Agent': 'EmarkNews/10.0.0',
                'Connection': 'close'
            }
        };

        console.log(`ğŸ“¡ NewsAPI ìš”ì²­: ${endpoint}`, validatedParams);

        const response = await axios.get(url, config);
        
        if (response.data.status !== 'ok') {
            throw new Error(`NewsAPI ì˜¤ë¥˜: ${response.data.message}`);
        }

        const articles = (response.data.articles || [])
            .filter(article => 
                article.title && 
                article.title !== '[Removed]' && 
                article.description && 
                article.description !== '[Removed]' &&
                article.url &&
                !article.url.includes('removed.com') &&
                !article.url.includes('example.com')
            )
            .map(article => ({
                id: this.generateId(article.url),
                title: article.title,
                description: article.description,
                url: article.url,
                originalUrl: article.url, // ì›ë¬¸ ë§í¬ ë³´ì¡´
                image: article.urlToImage,
                publishedAt: article.publishedAt,
                source: {
                    name: article.source.name,
                    display: this.getSourceDisplay(article.source.name, article.publishedAt)
                }
            }));

        console.log(`âœ… NewsAPI ${endpoint}ì—ì„œ ${articles.length}ê°œ ê¸°ì‚¬ ìˆ˜ì§‘`);
        return articles;
    }

    // NewsAPI íŒŒë¼ë¯¸í„° ê²€ì¦
    validateNewsAPIParams(params) {
        const validated = { ...params };
        
        // pageSize ì œí•œ
        if (validated.pageSize > 100) validated.pageSize = 100;
        
        // ë‚ ì§œ í˜•ì‹ ê²€ì¦
        if (validated.from && !this.isValidDate(validated.from)) {
            delete validated.from;
        }
        if (validated.to && !this.isValidDate(validated.to)) {
            delete validated.to;
        }
        
        // ì¿¼ë¦¬ ê¸¸ì´ ì œí•œ
        if (validated.q && validated.q.length > 500) {
            validated.q = validated.q.substring(0, 500);
        }
        
        return validated;
    }

    // ëª¨ë°”ì¼ ìµœì í™” ê¸°ì‚¬ ì²˜ë¦¬ (ì™„ì „ ê°œì„ )
    async processArticlesForMobileEnhanced(articles, section) {
        const processed = [];

        for (const article of articles) {
            try {
                // AI ë²ˆì—­ ë° ìš”ì•½ (ì™„ì „ ê°œì„ ëœ ë”ë³´ê¸° ê¸°ëŠ¥)
                const translatedContent = await this.translateAndSummarizeEnhanced(article, section);
                
                // ë§ˆí¬ ë¶„ì„
                const marks = this.analyzeMarks(article.title + ' ' + article.description);
                
                // í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
                const stars = this.calculateQualityScore(article, marks);
                
                // ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
                const category = this.classifyCategory(article.title + ' ' + article.description);
                
                // í‚¤ì›Œë“œ ì¶”ì¶œ
                const keywords = this.extractKeywords(article.title + ' ' + article.description);

                // ì¶œì²˜ ê²€ì¦
                const sourceVerification = this.verifySource(article);

                processed.push({
                    ...article,
                    summary: translatedContent.summary,
                    description: translatedContent.detailed,
                    fullContent: translatedContent.fullContent, // ë”ë³´ê¸°ìš© ìƒì„¸ ë‚´ìš©
                    marks,
                    stars,
                    category,
                    keywords,
                    sourceVerified: sourceVerification.verified,
                    sourceDisplay: sourceVerification.display
                });
            } catch (error) {
                console.error('âŒ ê¸°ì‚¬ ì²˜ë¦¬ ì‹¤íŒ¨:', error.message);
                // ê¸°ë³¸ ì²˜ë¦¬
                processed.push({
                    ...article,
                    summary: this.createBasicSummary(article),
                    fullContent: article.description || 'ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.',
                    marks: [],
                    stars: 3,
                    category: 'ì¼ë°˜',
                    keywords: ['ë‰´ìŠ¤'],
                    sourceVerified: false,
                    sourceDisplay: article.source?.name || 'ì¶œì²˜ì—†ìŒ'
                });
            }
        }

        return processed;
    }

    // ì¶œì²˜ ê²€ì¦
    verifySource(article) {
        const sourceName = article.source?.name || '';
        const url = article.originalUrl || article.url || '';
        
        // ì•Œë ¤ì§„ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì†ŒìŠ¤ í™•ì¸
        const trustedSources = Object.keys(this.sourceMapping);
        const isKnownSource = trustedSources.some(source => 
            sourceName.toLowerCase().includes(source) || 
            url.toLowerCase().includes(source)
        );
        
        // URL ìœ íš¨ì„± ê²€ì‚¬
        const hasValidUrl = url && url.startsWith('http') && !url.includes('example.com');
        
        let display = sourceName || 'ì¶œì²˜ì—†ìŒ';
        if (!sourceName || sourceName.trim() === '') {
            display = 'ì¶œì²˜ì—†ìŒ';
        } else if (this.sourceMapping[sourceName.toLowerCase()]) {
            display = this.sourceMapping[sourceName.toLowerCase()];
        }
        
        return {
            verified: isKnownSource && hasValidUrl,
            display: display
        };
    }

    // AI ë²ˆì—­ ë° ìš”ì•½ (ì™„ì „ ê°œì„ ëœ ë”ë³´ê¸° ê¸°ëŠ¥)
    async translateAndSummarizeEnhanced(article, section) {
        const content = article.title + '\n' + article.description;
        
        // OpenAI ì‹œë„ (ì™„ì „ ê°œì„ ëœ í”„ë¡¬í”„íŠ¸)
        try {
            if (this.apis.openAi && this.checkRateLimit('openAi')) {
                const result = await this.retryWithBackoff(
                    () => this.callOpenAIEnhanced(content, article),
                    'openAi'
                );
                return this.parseEnhancedTranslationResult(result);
            }
        } catch (error) {
            console.error('âŒ OpenAI ë²ˆì—­ ì‹¤íŒ¨:', error.message);
        }

        // Skywork AI ì‹œë„ (ì™„ì „ ê°œì„ ëœ í”„ë¡¬í”„íŠ¸)
        try {
            if (this.apis.skyworkAi && this.checkRateLimit('skywork')) {
                const result = await this.retryWithBackoff(
                    () => this.callSkyworkAIEnhanced(content, article),
                    'skyworkAi'
                );
                return this.parseEnhancedTranslationResult(result);
            }
        } catch (error) {
            console.error('âŒ Skywork AI ë²ˆì—­ ì‹¤íŒ¨:', error.message);
        }

        // ê¸°ë³¸ ì²˜ë¦¬
        return {
            summary: this.createBasicSummary(article),
            detailed: article.description || 'ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.',
            fullContent: this.createEnhancedFullContent(article)
        };
    }

    // OpenAI API í˜¸ì¶œ (ì™„ì „ ê°œì„ )
    async callOpenAIEnhanced(content, article) {
        const prompt = `ë‹¤ìŒ ë‰´ìŠ¤ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ê³  ëª¨ë°”ì¼ì—ì„œ ì½ê¸° ì‰½ê²Œ 3ë‹¨ê³„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:

ì œëª©: ${article.title}
ë‚´ìš©: ${article.description}
ì¶œì²˜: ${article.source?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}

ìš”êµ¬ì‚¬í•­:
1. ê¸°ë³¸ ìš”ì•½: 3-4ê°œì˜ í•µì‹¬ í¬ì¸íŠ¸ (ê° í•œ ì¤„)
2. ìƒì„¸ ì„¤ëª…: 2-3ë¬¸ì¥ìœ¼ë¡œ ì „ì²´ ë‚´ìš© ìš”ì•½
3. ì™„ì „í•œ ë‚´ìš©: ëª¨ë°”ì¼ì—ì„œ ì½ê¸° ì‰¬ìš´ ìƒì„¸í•œ ë¶„ì„ (5-8ë¬¸ì¥)

í˜•ì‹:
ê¸°ë³¸ìš”ì•½:
â€¢ ì²« ë²ˆì§¸ í•µì‹¬ ë‚´ìš©
â€¢ ë‘ ë²ˆì§¸ í•µì‹¬ ë‚´ìš©
â€¢ ì„¸ ë²ˆì§¸ í•µì‹¬ ë‚´ìš©

ìƒì„¸ì„¤ëª…:
ì „ì²´ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•œ ì„¤ëª…

ì™„ì „ë‚´ìš©:
ì´ ë‰´ìŠ¤ì— ëŒ€í•œ ìƒì„¸í•œ ë¶„ì„ê³¼ ë°°ê²½ ì„¤ëª…ì„ 5-8ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±. 
ê´€ë ¨ ë§¥ë½, ì˜í–¥, ì˜ë¯¸ ë“±ì„ í¬í•¨í•˜ì—¬ ë…ìê°€ ì™„ì „íˆ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª….

ì£¼ì˜ì‚¬í•­:
- ** í‘œì‹œë‚˜ êµµì€ ê¸€ì”¨ ì‚¬ìš© ê¸ˆì§€
- ëª¨ë°”ì¼ì—ì„œ ì½ê¸° ì‰½ê²Œ ê°„ê²°í•˜ê²Œ ì‘ì„±
- ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ ì œê±°
- í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë²ˆì—­`;

        const response = await axios.post('https://api.openai.com/v1/chat/completions', {
            model: 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 800, // í† í° ìˆ˜ ì¦ê°€
            temperature: 0.3
        }, {
            headers: {
                'Authorization': `Bearer ${this.apis.openAi}`,
                'Content-Type': 'application/json'
            },
            timeout: 20000
        });

        return response.data.choices[0].message.content;
    }

    // Skywork AI API í˜¸ì¶œ (ì™„ì „ ê°œì„ )
    async callSkyworkAIEnhanced(content, article) {
        const prompt = `ë‰´ìŠ¤ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ê³  3ë‹¨ê³„ ìš”ì•½:
1. ê¸°ë³¸ìš”ì•½: í•µì‹¬ í¬ì¸íŠ¸ 3-4ê°œ
2. ìƒì„¸ì„¤ëª…: ì „ì²´ ìš”ì•½ 2-3ë¬¸ì¥  
3. ì™„ì „ë‚´ìš©: ìƒì„¸ ë¶„ì„ 5-8ë¬¸ì¥

ë‚´ìš©: ${content}`;

        const response = await axios.post('https://api.skywork.ai/v1/chat/completions', {
            model: 'skywork-lite',
            messages: [{
                role: 'user',
                content: prompt
            }],
            max_tokens: 600
        }, {
            headers: {
                'Authorization': `Bearer ${this.apis.skyworkAi}`,
                'Content-Type': 'application/json'
            },
            timeout: 15000
        });

        return response.data.choices[0].message.content;
    }

    // ì™„ì „ ê°œì„ ëœ ë²ˆì—­ ê²°ê³¼ íŒŒì‹±
    parseEnhancedTranslationResult(result) {
        const lines = result.split('\n').filter(line => line.trim());
        
        let summary = '';
        let detailed = '';
        let fullContent = '';
        let currentSection = '';

        for (const line of lines) {
            const trimmedLine = line.trim();
            
            if (trimmedLine.includes('ê¸°ë³¸ìš”ì•½:') || trimmedLine.includes('ìš”ì•½:')) {
                currentSection = 'summary';
                continue;
            } else if (trimmedLine.includes('ìƒì„¸ì„¤ëª…:') || trimmedLine.includes('ìƒì„¸:')) {
                currentSection = 'detailed';
                continue;
            } else if (trimmedLine.includes('ì™„ì „ë‚´ìš©:') || trimmedLine.includes('ì™„ì „:')) {
                currentSection = 'fullContent';
                continue;
            }

            if (currentSection === 'summary' && trimmedLine.startsWith('â€¢')) {
                summary += trimmedLine + '\n';
            } else if (currentSection === 'detailed' && trimmedLine) {
                detailed += trimmedLine + ' ';
            } else if (currentSection === 'fullContent' && trimmedLine) {
                fullContent += trimmedLine + ' ';
            }
        }

        return {
            summary: summary.trim() || result.substring(0, 200) + '...',
            detailed: detailed.trim() || result.substring(0, 300) + '...',
            fullContent: fullContent.trim() || result
        };
    }

    // ì™„ì „í•œ ìƒì„¸ ë‚´ìš© ìƒì„±
    createEnhancedFullContent(article) {
        const title = article.title || '';
        const description = article.description || '';
        const source = article.source?.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜';
        
        return `${title}

${description}

ì´ ê¸°ì‚¬ëŠ” ${source}ì—ì„œ ë³´ë„ë˜ì—ˆìœ¼ë©°, í˜„ì¬ ì‹œì ì—ì„œ ì¤‘ìš”í•œ ë‰´ìŠ¤ë¡œ í‰ê°€ë©ë‹ˆë‹¤. 

ë” ìì„¸í•œ ì •ë³´ì™€ ìµœì‹  ì—…ë°ì´íŠ¸ëŠ” ì›ë¬¸ ë§í¬ë¥¼ í†µí•´ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
    }

    // API ë©”íŠ¸ë¦­ ë¦¬í¬íŠ¸ ìƒì„±
    getApiMetricsReport() {
        const report = {};
        
        Object.entries(this.apiMetrics).forEach(([apiName, metrics]) => {
            const total = metrics.success + metrics.failure;
            report[apiName] = {
                successRate: total > 0 ? Math.round((metrics.success / total) * 100) : 0,
                totalCalls: total,
                avgResponseTime: total > 0 ? Math.round(metrics.totalTime / total) : 0,
                lastError: metrics.lastError
            };
        });
        
        return report;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    isValidDate(dateString) {
        const date = new Date(dateString);
        return date instanceof Date && !isNaN(date);
    }

    containsKeywords(text, keywords) {
        const lowerText = text.toLowerCase();
        return keywords.some(keyword => lowerText.includes(keyword.toLowerCase()));
    }

    removeDuplicates(articles) {
        const seen = new Set();
        return articles.filter(article => {
            const key = article.title.substring(0, 50);
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });
    }

    filterRecentNews(articles) {
        const twoDaysAgo = new Date(Date.now() - 48 * 60 * 60 * 1000);
        return articles.filter(article => {
            const publishedDate = new Date(article.publishedAt);
            return publishedDate >= twoDaysAgo;
        });
    }

    analyzeMarks(content) {
        const marks = [];
        const lowerContent = content.toLowerCase();
        
        if (this.containsKeywords(lowerContent, this.keywords.urgent)) marks.push('ê¸´ê¸‰');
        if (this.containsKeywords(lowerContent, this.keywords.important)) marks.push('ì¤‘ìš”');
        if (this.containsKeywords(lowerContent, this.keywords.buzz)) marks.push('Buzz');
        
        return marks;
    }

    calculateQualityScore(article, marks) {
        let score = 3; // ê¸°ë³¸ ì ìˆ˜
        
        if (marks.includes('ê¸´ê¸‰')) score += 1;
        if (marks.includes('ì¤‘ìš”')) score += 1;
        if (marks.includes('Buzz')) score += 0.5;
        if (article.image) score += 0.5;
        if (article.description && article.description.length > 100) score += 0.5;
        if (article.originalUrl && article.originalUrl !== article.url) score += 0.5;
        
        return Math.min(Math.round(score), 5);
    }

    classifyCategory(content) {
        const lowerContent = content.toLowerCase();
        
        if (this.containsKeywords(lowerContent, ['ì •ì¹˜', 'politics', 'government', 'election'])) return 'ì •ì¹˜';
        if (this.containsKeywords(lowerContent, ['ê²½ì œ', 'economy', 'business', 'finance', 'market'])) return 'ê²½ì œ';
        if (this.containsKeywords(lowerContent, ['ìŠ¤í¬ì¸ ', 'sports', 'game', 'match', 'baseball', 'soccer'])) return 'ìŠ¤í¬ì¸ ';
        if (this.containsKeywords(lowerContent, ['ê¸°ìˆ ', 'technology', 'tech', 'ai', 'digital', 'software'])) return 'ê¸°ìˆ ';
        if (this.containsKeywords(lowerContent, ['ê³¼í•™', 'science', 'research', 'study', 'discovery'])) return 'ê³¼í•™';
        if (this.containsKeywords(lowerContent, ['ë¬¸í™”', 'culture', 'art', 'entertainment', 'movie', 'music'])) return 'ë¬¸í™”';
        if (this.containsKeywords(lowerContent, ['ê±´ê°•', 'health', 'medical', 'hospital', 'disease'])) return 'ê±´ê°•';
        if (this.containsKeywords(lowerContent, ['í™˜ê²½', 'environment', 'climate', 'green', 'pollution'])) return 'í™˜ê²½';
        
        return 'ì¼ë°˜';
    }

    extractKeywords(content) {
        const words = content.toLowerCase().match(/\b\w{3,}\b/g) || [];
        const keywordCount = new Map();
        
        words.forEach(word => {
            if (!this.isStopWord(word)) {
                keywordCount.set(word, (keywordCount.get(word) || 0) + 1);
            }
        });
        
        return Array.from(keywordCount.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8) // í‚¤ì›Œë“œ ìˆ˜ ì¦ê°€
            .map(([word]) => word);
    }

    isStopWord(word) {
        const stopWords = ['the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these', 'those', 'a', 'an'];
        return stopWords.includes(word.toLowerCase()) || word.length < 3;
    }

    getSourceDisplay(sourceName, publishedAt) {
        const mappedName = this.sourceMapping[sourceName.toLowerCase()] || sourceName;
        const date = new Date(publishedAt);
        const timeString = date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        return `${mappedName} ${timeString}`;
    }

    cleanNaverText(text) {
        return text.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, '').trim();
    }

    generateId(url) {
        return Buffer.from(url).toString('base64').substring(0, 16);
    }

    createBasicSummary(article) {
        const description = article.description || '';
        const sentences = description.split('.').filter(s => s.trim().length > 10);
        
        if (sentences.length >= 2) {
            return sentences.slice(0, 3).map(s => `â€¢ ${s.trim()}`).join('\n');
        }
        
        return `â€¢ ${description.substring(0, 100)}...`;
    }

    async generateTrendingKeywords(articles) {
        const keywordCount = new Map();
        
        articles.forEach(article => {
            const content = (article.title + ' ' + article.description).toLowerCase();
            const words = content.match(/\b\w{2,}\b/g) || [];
            
            words.forEach(word => {
                if (word.length > 2 && !this.isStopWord(word)) {
                    keywordCount.set(word, (keywordCount.get(word) || 0) + 1);
                }
            });
        });

        return Array.from(keywordCount.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 15) // íŠ¸ë Œë”© í‚¤ì›Œë“œ ìˆ˜ ì¦ê°€
            .map(([keyword, count]) => [keyword, Math.min(count, 100)]);
    }

    // ê¸°ë³¸ ë‰´ìŠ¤ ë°ì´í„° (ëŒ€ëŸ‰)
    getDefaultNews() {
        const now = new Date().toISOString();
        
        const createNewsItem = (id, title, summary, category, marks = [], fullContent = null) => ({
            id,
            title,
            summary,
            description: summary,
            fullContent: fullContent || summary + '\n\nì´ ê¸°ì‚¬ì— ëŒ€í•œ ë” ìì„¸í•œ ì •ë³´ëŠ” ì›ë¬¸ì„ ì°¸ì¡°í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. í˜„ì¬ ì‹œì ì—ì„œ ì¤‘ìš”í•œ ë‰´ìŠ¤ë¡œ í‰ê°€ë˜ë©°, ê´€ë ¨ ë¶„ì•¼ì˜ ì „ë¬¸ê°€ë“¤ì´ ì£¼ëª©í•˜ê³  ìˆëŠ” ì‚¬ì•ˆì…ë‹ˆë‹¤.',
            url: 'https://www.example.com/news/' + id,
            originalUrl: null,
            image: null,
            publishedAt: now,
            source: { 
                name: 'EmarkNews', 
                display: 'EmarkNews ' + new Date().toLocaleString('ko-KR') 
            },
            category,
            marks,
            stars: 4,
            keywords: ['ë‰´ìŠ¤', 'ì •ë³´', 'ì‹¤ì‹œê°„'],
            sourceVerified: false,
            sourceDisplay: 'EmarkNews'
        });

        return {
            sections: {
                world: [
                    createNewsItem(
                        'world-1',
                        'NASA ìš°ì£¼ë¹„í–‰ì‚¬ ì§€êµ¬ ê·€í™˜ ì„±ê³µ',
                        'â€¢ NASA í¬ë£¨-10 ë¯¸ì…˜ 4ëª… ìš°ì£¼ë¹„í–‰ì‚¬ê°€ 5ê°œì›”ê°„ì˜ êµ­ì œìš°ì£¼ì •ê±°ì¥ ì²´ë¥˜ë¥¼ ë§ˆì¹˜ê³  ì•ˆì „í•˜ê²Œ ì§€êµ¬ë¡œ ê·€í™˜í–ˆìŠµë‹ˆë‹¤\nâ€¢ ì¬ì§„ì… ê³¼ì •ì—ì„œ 3,000ë„ ê³ ì˜¨ì„ ê²½í—˜í•˜ë©° 17ì‹œê°„ì˜ ì—¬í–‰ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤\nâ€¢ ì´ë²ˆ ë¯¸ì…˜ì—ì„œëŠ” ë‹¤ì–‘í•œ ê³¼í•™ ì‹¤í—˜ê³¼ ìš°ì£¼ì •ê±°ì¥ ìœ ì§€ë³´ìˆ˜ ì‘ì—…ì„ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤',
                        'ê³¼í•™',
                        ['ì¤‘ìš”', 'Buzz'],
                        'NASA í¬ë£¨-10 ë¯¸ì…˜ì˜ ì„±ê³µì ì¸ ì™„ë£ŒëŠ” êµ­ì œìš°ì£¼ì •ê±°ì¥ í”„ë¡œê·¸ë¨ì˜ ì¤‘ìš”í•œ ì´ì •í‘œì…ë‹ˆë‹¤. 4ëª…ì˜ ìš°ì£¼ë¹„í–‰ì‚¬ë“¤ì€ ì§€ë‚œ 5ê°œì›” ë™ì•ˆ ë¬´ì¤‘ë ¥ í™˜ê²½ì—ì„œ ë‹¤ì–‘í•œ ê³¼í•™ ì‹¤í—˜ì„ ìˆ˜í–‰í–ˆìœ¼ë©°, íŠ¹íˆ ì˜í•™ ì—°êµ¬ì™€ ì¬ë£Œ ê³¼í•™ ë¶„ì•¼ì—ì„œ ì¤‘ìš”í•œ ì„±ê³¼ë¥¼ ê±°ë‘ì—ˆìŠµë‹ˆë‹¤. ì´ë²ˆ ê·€í™˜ ê³¼ì •ì—ì„œ ì‚¬ìš©ëœ ìµœì‹  ì—´ ì°¨í ê¸°ìˆ ì€ í–¥í›„ í™”ì„± íƒì‚¬ ë¯¸ì…˜ì—ë„ í™œìš©ë  ì˜ˆì •ì…ë‹ˆë‹¤.'
                    )
                ],
                korea: [
                    createNewsItem(
                        'korea-1',
                        'ì†í¥ë¯¼ MLS ë°ë·”ì „ì—ì„œ ê°•ë ¬í•œ ì¸ìƒ',
                        'â€¢ ì†í¥ë¯¼ ì„ ìˆ˜ê°€ ë¯¸êµ­ ë©”ì´ì €ë¦¬ê·¸ ì‚¬ì»¤ ë°ë·”ì „ì—ì„œ 1ê³¨ 1ì–´ì‹œìŠ¤íŠ¸ë¥¼ ê¸°ë¡í•˜ë©° í™”ë ¤í•œ í™œì•½ì„ í¼ì³¤ìŠµë‹ˆë‹¤\nâ€¢ MLS í™ˆí˜ì´ì§€ì—ì„œ "ì†í¥ë¯¼ì˜ ì‹œëŒ€ê°€ ì‹œì‘ëë‹¤"ê³  ê·¹ì°¬í–ˆìŠµë‹ˆë‹¤\nâ€¢ íŒ¬ë“¤ê³¼ ì–¸ë¡ ì€ ê·¸ì˜ MLS ì ì‘ë ¥ê³¼ ë¦¬ë”ì‹­ì— ëŒ€í•´ ë†’ì€ ê¸°ëŒ€ë¥¼ í‘œí•˜ê³  ìˆìŠµë‹ˆë‹¤',
                        'ìŠ¤í¬ì¸ ',
                        ['ê¸´ê¸‰', 'Buzz'],
                        'ì†í¥ë¯¼ì˜ MLS ë°ë·”ëŠ” í•œêµ­ ì¶•êµ¬ ì—­ì‚¬ì— ìƒˆë¡œìš´ ì¥ì„ ì—´ì—ˆìŠµë‹ˆë‹¤. í† íŠ¸ë„˜ì—ì„œì˜ ì„±ê³µì ì¸ ì»¤ë¦¬ì–´ë¥¼ ë§ˆì¹˜ê³  ìƒˆë¡œìš´ ë„ì „ì„ ì‹œì‘í•œ ì†í¥ë¯¼ì€ ì²« ê²½ê¸°ë¶€í„° ë›°ì–´ë‚œ ê²½ê¸°ë ¥ì„ ë³´ì—¬ì£¼ì—ˆìŠµë‹ˆë‹¤. ê·¸ì˜ í•©ë¥˜ë¡œ MLSì˜ ì•„ì‹œì•„ ì‹œì¥ ê´€ì‹¬ë„ê°€ í¬ê²Œ ë†’ì•„ì§ˆ ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ë©°, í•œêµ­ ì„ ìˆ˜ë“¤ì˜ í•´ì™¸ ì§„ì¶œì—ë„ ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì¹  ê²ƒìœ¼ë¡œ ì „ë§ë©ë‹ˆë‹¤.'
                    )
                ],
                japan: [
                    createNewsItem(
                        'japan-1',
                        'ì˜¤íƒ€ë‹ˆ ì‡¼í—¤ì´, ì‹œì¦Œ 50í™ˆëŸ° ë‹¬ì„±',
                        'â€¢ ì˜¤íƒ€ë‹ˆ ì‡¼í—¤ì´ê°€ 2024ì‹œì¦Œ 50ë²ˆì§¸ í™ˆëŸ°ì„ ê¸°ë¡í•˜ë©° ì—­ì‚¬ì ì¸ ìˆœê°„ì„ ë§Œë“¤ì–´ëƒˆìŠµë‹ˆë‹¤\nâ€¢ ì´ëŠ” ì¼ë³¸ ì„ ìˆ˜ë¡œëŠ” ìµœì´ˆë¡œ MLBì—ì„œ 50í™ˆëŸ°ì„ ë‹¬ì„±í•œ ê¸°ë¡ì…ë‹ˆë‹¤\nâ€¢ íŒ¬ë“¤ê³¼ ì–¸ë¡ ì€ ê·¸ì˜ ë†€ë¼ìš´ ì„±ê³¼ì— ëŒ€í•´ ê·¹ì°¬ì„ ì•„ë¼ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤',
                        'ìŠ¤í¬ì¸ ',
                        ['ì¤‘ìš”', 'Buzz'],
                        'ì˜¤íƒ€ë‹ˆ ì‡¼í—¤ì´ì˜ 50í™ˆëŸ° ë‹¬ì„±ì€ ì¼ë³¸ ì•¼êµ¬ ì—­ì‚¬ìƒ ê°€ì¥ ìœ„ëŒ€í•œ ìˆœê°„ ì¤‘ í•˜ë‚˜ë¡œ ê¸°ë¡ë  ê²ƒì…ë‹ˆë‹¤. íˆ¬íƒ€ ê²¸ì—…ì´ë¼ëŠ” ë…íŠ¹í•œ í¬ì§€ì…˜ì—ì„œ ì´ëŸ° ì„±ê³¼ë¥¼ ê±°ë‘” ê²ƒì€ ì „ë¡€ê°€ ì—†ëŠ” ì¼ì…ë‹ˆë‹¤. ì´ë²ˆ ê¸°ë¡ìœ¼ë¡œ ê·¸ëŠ” MVP í›„ë³´ 1ìˆœìœ„ë¡œ ë– ì˜¬ëìœ¼ë©°, ì¼ë³¸ ë‚´ì—ì„œëŠ” êµ­ë¯¼ì  ì˜ì›…ìœ¼ë¡œ ì¶”ì•™ë°›ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ì˜ ì„±ê³µì€ ì¼ë³¸ ì•¼êµ¬ì˜ ìœ„ìƒì„ ì „ ì„¸ê³„ì— ì•Œë¦¬ëŠ” ê³„ê¸°ê°€ ë˜ê³  ìˆìŠµë‹ˆë‹¤.'
                    )
                ]
            },
            trending: [
                ['NASA', 45], ['ì†í¥ë¯¼', 42], ['ì˜¤íƒ€ë‹ˆ', 40], ['MLS', 35], 
                ['ìš°ì£¼íƒì‚¬', 30], ['ìŠ¤í¬ì¸ ', 28], ['ê³¼í•™', 25], ['ê¸°ìˆ ', 22],
                ['ì•¼êµ¬', 20], ['ì¶•êµ¬', 18], ['í•œêµ­', 15], ['ì¼ë³¸', 12]
            ],
            exchangeRates: this.exchangeRates
        };
    }

    // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
    getSystemStatus() {
        return {
            status: 'running',
            version: '10.0.0-complete-enhanced',
            uptime: process.uptime(),
            memory: process.memoryUsage(),
            lastUpdate: this.lastUpdate,
            cacheSize: this.cache.size,
            isUpdating: this.isUpdating,
            features: [
                'large-scale-news-collection',
                'real-time-exchange-rates',
                'enhanced-ai-translation',
                'source-verification',
                'detailed-content-generation',
                'mobile-optimization',
                'exponential-backoff-retry',
                'api-monitoring-system'
            ],
            apiMetrics: this.getApiMetricsReport(),
            rateLimits: this.rateLimits,
            exchangeRates: this.exchangeRates,
            apiSources: {
                newsApi: !!this.apis.newsApi,
                naverApi: !!(this.apis.naverClientId && this.apis.naverClientSecret),
                openAi: !!this.apis.openAi,
                skyworkAi: !!this.apis.skyworkAi,
                exchangeApi: true
            }
        };
    }
}

module.exports = CompleteNewsSystemWithEnhancements;